% \RequirePackage{poetry-bfi}
\RequirePackage{substr}
\newcommand*\periodafter[1]{#1%
\IfBehindSubStringEmpty{.}{#1}{}{%
\IfBehindSubStringEmpty{?}{#1}{}{%
\IfBehindSubStringEmpty{!}{#1}{}{%
\IfBehindSubStringEmpty{:}{#1}{}{%
\IfBehindSubStringEmpty{,}{#1}{}{%
\IfBehindSubStringEmpty{;}{#1}{}{.}}}}}}}
\usepackage[perpage,para*]{manyfoot}
\SelectFootnoteRule{default}
\newfootnote[para]{C}
\newcounter{footnoteC}
%\renewcommand{\thefootnoteC}{\fontfamily{MinionPro-OsF}\fontencoding{T1}\selectfont{[\arabic{footnoteC}]}}
\renewcommand{\thefootnoteC}{\alph{footnoteC}}
\newcommand{\footnoteC}{%
  \stepcounter{footnoteC}%
  {\Footnotemark\thefootnoteC}\FootnotetextC{}}
\MakePerPage{footnoteC}

\SelectFootnoteRule{default}
\newfootnote{D}
\newcounter{footnoteD}
\renewcommand{\thefootnoteD}{\emph{\alph{footnoteD}}}
\newcommand{\footnoteD}{%
  \stepcounter{footnoteD}%
  {\Footnotemark\thefootnoteD}\FootnotetextD{}}
\MakePerPage{footnoteD}

\SelectFootnoteRule{default}
\newfootnote[para]{E}
\newcounter{footnoteE}
\renewcommand{\thefootnoteE}{\alph{footnoteE}}
\newcommand{\footnoteE}{%
  \stepcounter{footnoteE}%
  {\Footnotemark\thefootnoteE}\FootnotetextE{}}
\MakePerPage{footnoteE}

\makeatletter
% counterless footnote from
% https://tex.stackexchange.com/questions/562763/footnote-without-reference
\newcommand\freefootnoteNormal[1]{%
  \let\svthefootnote\thefootnote
  \begingroup\freefootnotedef
  \let\thefootnote\relax%
  \footnotetext{#1}%
  \let\thefootnote\svthefootnote%
  \endgroup
}
\newcommand\freefootnoteD[1]{%
  \let\svthefootnote\thefootnoteD
  \begingroup\freefootnotedef
  \let\thefootnoteD\relax%
  \FootnotetextD{}{#1}%
  \let\thefootnoteD\svthefootnote%
  \endgroup
}
\newcommand\freefootnoteC[1]{%
  \let\svthefootnote\thefootnoteC
  \begingroup\freefootnotedef
  \let\thefootnoteC\relax%
  \FootnotetextC{}{#1}%
  \let\thefootnoteC\svthefootnote%
  \endgroup
}
\newcommand\freefootnoteE[1]{%
  \let\svthefootnote\thefootnoteE
  \begingroup\freefootnotedef
  \let\thefootnoteE\relax%
  \FootnotetextE{}{#1}%
  \let\thefootnoteE\svthefootnote%
  \endgroup
}
%%% end
\makeatother
\ifcsname rechts\endcsname\else
  \newcommand{\rechts}[1]{\strut\hfill\mbox{#1}}
\fi
% \newcommand{\vocabseparator}{]}
\newcounter{previousline}
\setcounter{previousline}{-1}
\newcounter{previousCommentline}
\setcounter{previousCommentline}{-1}
\newcommand{\vocabseparator}{\,}
\newcommand{\commentseparator}{:\,}
\newcommand{\vocabnote}[3][]{%
  % arguments: [lemma]{text}{meaning}
  \vocablemmanote[#1]{#2}{#2}{#3}}
\newcommand{\vocabComment}[3][]{%
  % arguments: [lemma]{text}{comment}
  \vocablemmaComment[#1]{#2}{#2}{#3}}
\let\vocCom=\vocabComment
\let\vocnote=\vocabnote
\ifcsname thepoemline\endcsname
  \let\thelinecounter=\thepoemline
  \newcommand{\linecounter}{poemline}
\else
  \ifcsname thelinenumber\endcsname
    \let\thelinecounter=\thelinenumber
    \newcommand{\linecounter}{linenumber}
  \else
    \newcommand{\linecounter}\errmessage{No supported line numbering present.
    \let\thelinecounter=\linecounter
  \fi
\fi
\newif\ifvocPerline\vocPerlinefalse
\newif\ifcommentPerline\commentPerlinefalse
\newlength{\voclinenowidth}
\setlength{\voclinenowidth}{3ex}
\newcommand{\vocablemmaComment}[4][]{%
  % arguments: [remark before]{text}{lemma}{comment}
    #2\ifx\commentfootnote\freefootnoteE\textsuperscript{\textdagger}\fi%
    \def\tmp{#1}% remark before
    \def\tmptmp{#4}% comment
  \commentfootnote{\ifnum\the\value{previousCommentline}=\the\value{\linecounter}\else\ifcommentPerline\newline\makebox[\voclinenowidth][r]{\textbf{\thelinecounter}}
  \else\textbf{\thelinecounter} \fi\fi\emph{#3}\hskip0.2ex\commentseparator{}\periodafter{\ifx \tmp\empty\else \tmp{}\fi\ifx \tmptmp\empty\else{} \tmptmp{}\fi}}\setcounter{previousCommentline}{\value{\linecounter}}}
\let\voclemCom=\vocablemmaComment
\newcommand{\vocablemmanotePara}[4][]{%
  % arguments: [remark before]{text}{lemma}{meaning}
    #2\ifx\vocfootnote\freefootnoteC\textsuperscript{*}\fi%
    \def\tmp{#1}%
    \def\tmptmp{#4}%
  \vocfootnote{\ifnum\the\value{previousline}=\the\value{\linecounter}\else\ifvocPerline\newline\makebox[\voclinenowidth][r]{\textbf{\thelinecounter}}
    \else\textbf{\thelinecounter}
    \fi\fi\emph{#3}\hskip0.2ex\vocabseparator{}\periodafter{\ifx \tmp\empty\else
    \tmp{}\fi\ifx \tmptmp\empty\else
  ‚\tmptmp{}‘\fi}}\setcounter{previousline}{\value{\linecounter}}}
\let\commentfootnote=\freefootnoteE
\newcommand{\vocablemmanoteClassic}[4][]{%
  % arguments: [remark before]{text}{lemma}{meaning}
    #2\ifx\vocfootnote\freefootnoteD\textsuperscript{*}\fi%
    \def\tmp{#1}%
    \def\tmptmp{#4}%
  \vocfootnote{\textbf{\thepoemline} \emph{#3}\hskip0.2ex\vocabseparator{} \ifx \tmp\empty\else \tmp{} \fi\ifx \tmptmp\empty\else ‚\tmptmp{}‘\fi}}
\newcommand{\classicVocabnotes}{
    \let\vocablemmanote=\vocablemmanoteClassic
    \let\voclemnote=\vocablemmanote
    \let\freefootnote=\freefootnoteD
    \let\vocfootnote=\footnoteD
  }
\newcommand{\paraVocabnotes}{
  \let\vocablemmanote=\vocablemmanotePara
  \let\voclemnote=\vocablemmanotePara
  \let\freefootnote=\freefootnoteC
  \let\vocfootnote\freefootnote
}
\newcommand{\normalVocabnotes}{
  \let\vocablemmanote=\vocablemmanoteClassic
  \let\voclemnote=\vocablemmanoteClassic
  \let\freefootnote=\freefootnoteNormal
  \let\vocfootnote\freefootnoteNormal
}
\classicVocabnotes
\newlength{\vocabboxwidth}
\setlength{\vocabboxwidth}{6em}
\newlength{\phraseboxwidth}
\setlength{\phraseboxwidth}{13em}
\newlength{\vocabboxlinewidth}
\setlength{\vocabboxlinewidth}{.82\linewidth}
\newlength{\phraseboxlinewidth}
\setlength{\phraseboxlinewidth}{.57\linewidth}
\newcommand{\vocabbox}[2][]{%
    \def\tmp{#1}%
    \makebox[\vocabboxwidth][l]{\emph{#2} (Z. \ref{\ifx \tmp\empty word:#2\else word:#1\fi}):} \hfill\rule{\vocabboxlinewidth}{.4pt}\zeilen{1}
}
\newcommand{\phrasebox}[2][]{%
    \def\tmp{#1}%
    \makebox[\phraseboxwidth][l]{\emph{#2} (Z. \ref{\ifx \tmp\empty word:#2\else word:#1\fi}):} \hfill\rule{\phraseboxlinewidth}{.4pt}\zeilen{1}
}
\usepackage{forloop}
\newcounter{looping}
\newcommand{\zeilen}[1]{
\begingroup
    \parskip=1em
    \forloop{looping}{0}{\value{looping} < #1}{%
        \par{}\rule{\linewidth}{0.4pt}%
    }\vskip2em\endgroup}
\newcommand{\kurzzeilen}[1]{
    \begingroup
        \parskip=1em
        \forloop{looping}{0}{\value{looping} < #1}{%
            \par{}\rule{0.8\linewidth}{0.4pt}%
        }\vskip2em\endgroup}
